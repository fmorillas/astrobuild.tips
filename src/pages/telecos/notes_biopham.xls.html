<%args>
  $curs => undef
</%args>
<%init>

open my $fh, '>', \my $str or die "Failed to open filehandle: $!";
binmode STDOUT;
my $workbook  = Spreadsheet::WriteExcel->new($fh);
  
my $ws = &crea_worksheet($curs."-".($curs+1), $workbook);

my $i = 0;
$ws->set_column($i,$i,10);
$ws->write(0,$i++,"doc_identitat");
$ws->set_column($i,$i,15);
$ws->write(0,$i++,"primer_cognom");
$ws->set_column($i,$i,15);
$ws->write(0,$i++,"segon_cognom");
$ws->set_column($i,$i,15);
$ws->write(0,$i++,"nom");
$ws->set_column($i,$i,10);
$ws->write(0,$i++,"codi_upc_ud");
$ws->set_column($i,$i,8);
$ws->write(0,$i++,"sigles_ud"); 
$ws->set_column($i,$i,50);
$ws->write(0,$i++,"nom_ud");
$ws->set_column($i,$i,8);
$ws->write(0,$i++,"curs"); 
$ws->set_column($i,$i,8);
$ws->write(0,$i++,"quad"); 
$ws->set_column($i,$i,8);
$ws->write(0,$i++,"nota_num");  
$ws->set_column($i,$i,8);
$ws->write(0,$i++,"nota_des");  
$ws->set_column($i,$i,8);
$ws->write(0,$i++,"nota_ects");  

my $res = SI::BD::sql($BD_B3,
  " select d.doc_identitat, d.primer_cognom, d.segon_cognom, d.nom, q.codi_upc_ud, q.sigles_ud, 
      ud.nom_eng, ud.credits_ects, q.curs, q.quad, q.nota_num_def, q.nota_des_def, q.nota_ects
  from vm_qualificacions_ud q
  join vm_unitats_docents ud using (codi_upc_ud)
  join vm_expedients e using (codi_expedient)
  join vm_dades_estudiants d using (codi_estudiant)
 where e.codi_programa = 1431
   and d.centre = 230
   and e.curs_inici = ?
 order by d.primer_cognom, d.segon_cognom, d.nom, q.sigles_ud ",
  [$curs]
);

my $j = 1;
my %totals;
foreach(@$res) {
  $i = 0;
  $ws->write_string($j,$i++,$_->{doc_identitat});
  $ws->write_string($j,$i++,$_->{primer_cognom});
  $ws->write_string($j,$i++,$_->{segon_cognom});
  $ws->write_string($j,$i++,$_->{nom}); 
  $ws->write_string($j,$i++,$_->{codi_upc_ud});
  $ws->write_string($j,$i++,$_->{sigles_ud}); 
  $ws->write_string($j,$i++,$_->{nom_eng}); 
  $ws->write_string($j,$i++,$_->{curs}); 
  $ws->write_string($j,$i++,$_->{quad}); 
  $ws->write_number($j,$i++,$_->{nota_num_def}); 
  $ws->write_string($j,$i++,$_->{nota_des_def}); 
  $ws->write_string($j++,$i++,$_->{nota_ects}); 
}



# Enviem el fitxer XLS a la sortida

$workbook->close();

$m->print($str);

$r->content_type('application/vnd.ms-excel');
$r->headers_out->{'Content-Disposition'} = "attachment;  filename=notes_biopham_".$curs."_".($curs+1).".xls";


sub crea_worksheet { 
  my ($titol, $wb) = @_;
  
  my $ws = $wb->addworksheet("$titol");
    
  return $ws;
}
</%init>